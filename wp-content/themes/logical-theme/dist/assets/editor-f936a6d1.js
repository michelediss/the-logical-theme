const k={name:"paragraph",title:"Paragrafo",defaultVariant:"1",variants:[{value:"1",label:"Checkerboard A (testo a sinistra)"},{value:"2",label:"Checkerboard B (testo a destra)"}],fields:[{key:"pretitle",label:"Pretitle",input:"text",sanitize:"text",default:""},{key:"title",label:"Title",input:"text",sanitize:"text",default:""},{key:"text",label:"Text",input:"textarea",sanitize:"html",default:""}]},{registerBlockType:z}=wp.blocks,{InspectorControls:A,useBlockProps:U,MediaUpload:q,MediaUploadCheck:Q}=wp.blockEditor,{PanelBody:D,TextControl:O,TextareaControl:K,Button:m,SelectControl:b}=wp.components,{createElement:p,useEffect:B,Fragment:te}=wp.element,{__:n}=wp.i18n,{subscribe:X,select:P,dispatch:Z}=wp.data,F=wp.serverSideRender,M="_logical_content_json",G="2.0",H="3.0",E="logical-theme/paragraph",N="logical-theme/layout";function v(a){return`${a}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,7)}`}function h(a){return typeof a=="string"?a:""}function C(a){const t=Number.parseInt(a,10);return Number.isNaN(t)?12:Math.max(1,Math.min(12,t))}function x(a){if(!a||typeof a!="string")return null;try{const t=JSON.parse(a);if(!t||typeof t!="object")return null;if(t.version===G&&Array.isArray(t.sections)||t.version===H&&Array.isArray(t.layout))return t}catch{return null}return null}function S(a,t,c){t({data:{...a.data||{},...c}})}function J(a,t,c){t({settings:{...a.settings||{},...c}})}function W(){const a=P("core/block-editor"),t=a!=null&&a.getSettings?a.getSettings():null,u=(Array.isArray(t==null?void 0:t.colors)?t.colors:[]).map(o=>{if(!o||typeof o!="object")return null;const i=h(o.slug);if(!i)return null;const g=h(o.name)||i;return{value:i,label:g}}).filter(Boolean);return[{value:"",label:n("Default","wp-logical-theme")},...u]}function I(a,t){const c=a.data||{},u=a.settings||{},o=Array.isArray(k==null?void 0:k.fields)?k.fields:[],i=Array.isArray(k==null?void 0:k.variants)?k.variants:[],g=k.defaultVariant,s=[],l=i.map(e=>{if(e&&typeof e=="object"){const d=typeof e.value=="string"?e.value:"",f=typeof e.label=="string"&&e.label!==""?e.label:d;return d?{value:d,label:f}:null}return typeof e=="string"&&e!==""?{value:e,label:e}:null}).filter(Boolean);l.length>0&&s.push(p(b,{key:"paragraph-variant",label:n("Variant","wp-logical-theme"),value:h(u.variant||g),options:l,onChange:e=>J(a,t,{variant:e})})),s.push(p(b,{key:"paragraph-surface-color",label:n("Section background","wp-logical-theme"),value:h(u.backgroundColor),options:W(),onChange:e=>J(a,t,{backgroundColor:e})})),o.forEach(e=>{if(!e||typeof e!="object"||typeof e.key!="string")return;const d=e.key,f=typeof e.label=="string"&&e.label!==""?e.label:d,T=e.input==="textarea"?"textarea":"text",w=h(c[d]??e.default??"");if(T==="textarea"){s.push(p(K,{key:d,label:n(f,"wp-logical-theme"),value:w,onChange:$=>S(a,t,{[d]:$})}));return}s.push(p(O,{key:d,label:n(f,"wp-logical-theme"),value:w,onChange:$=>S(a,t,{[d]:$})}))});const r=c.image&&typeof c.image=="object"?c.image:{};return s.push(p(Q,{key:"paragraph-image-check"},p(q,{onSelect:e=>{const d={id:(e==null?void 0:e.id)||0,src:(e==null?void 0:e.url)||"",alt:(e==null?void 0:e.alt)||(e==null?void 0:e.title)||""};S(a,t,{image:d})},allowedTypes:["image"],value:r.id||0,render:({open:e})=>p(m,{variant:"secondary",onClick:e},r!=null&&r.src?n("Change image","wp-logical-theme"):n("Select image","wp-logical-theme"))}))),r!=null&&r.src&&(s.push(p(O,{key:"paragraph-image-alt",label:n("Image Alt","wp-logical-theme"),value:h(r.alt),onChange:e=>S(a,t,{image:{...r,alt:e}})})),s.push(p(m,{key:"paragraph-image-remove",variant:"secondary",isDestructive:!0,onClick:()=>S(a,t,{image:{id:0,src:"",alt:""}})},n("Remove image","wp-logical-theme")))),s}function _(a){return(Array.isArray(a)?a:[]).map(c=>{const u=c!=null&&c.settings&&typeof c.settings=="object"?c.settings:{},o=Array.isArray(c==null?void 0:c.columns)?c.columns:[];return{id:h(c==null?void 0:c.id)||v("row"),type:"row",settings:{container:["default","wide","full"].includes(u.container)?u.container:"default",gap:["none","sm","md","lg"].includes(u.gap)?u.gap:"md",alignY:["start","center","end","stretch"].includes(u.alignY)?u.alignY:"stretch",backgroundColor:h(u.backgroundColor)},columns:o.map(i=>{const g=i!=null&&i.settings&&typeof i.settings=="object"?i.settings:{},s=Array.isArray(i==null?void 0:i.items)?i.items:[];return{id:h(i==null?void 0:i.id)||v("col"),type:"column",settings:{desktop:C(g.desktop),tablet:C(g.tablet),mobile:C(g.mobile),alignY:["start","center","end","stretch"].includes(g.alignY)?g.alignY:"stretch"},items:s.map(l=>{var e,d,f,T,w,$,R,j;return(["paragraph","embed"].includes(h(l==null?void 0:l.type))?h(l.type):"paragraph")==="embed"?{id:h(l==null?void 0:l.id)||v("item"),type:"embed",data:{url:h((e=l==null?void 0:l.data)==null?void 0:e.url),provider:h((d=l==null?void 0:l.data)==null?void 0:d.provider)},settings:{}}:{id:h(l==null?void 0:l.id)||v("item"),type:"paragraph",data:{pretitle:h((f=l==null?void 0:l.data)==null?void 0:f.pretitle),title:h((T=l==null?void 0:l.data)==null?void 0:T.title),text:h((w=l==null?void 0:l.data)==null?void 0:w.text),image:($=l==null?void 0:l.data)!=null&&$.image&&typeof l.data.image=="object"?l.data.image:{id:0,src:"",alt:""}},settings:{variant:h((R=l==null?void 0:l.settings)==null?void 0:R.variant)||"1",backgroundColor:h((j=l==null?void 0:l.settings)==null?void 0:j.backgroundColor)}}})}})}})}function Y(a){const t=_(a);return t.length>0?t:[{id:v("row"),type:"row",settings:{container:"default",gap:"md",alignY:"stretch",backgroundColor:""},columns:[{id:v("col"),type:"column",settings:{desktop:12,tablet:12,mobile:12,alignY:"stretch"},items:[]}]}]}function y(a,t,c){const u=_(a);c(u),t({layout:_(u)})}function L(a){return a==="embed"?{id:v("item"),type:"embed",data:{url:"",provider:""},settings:{}}:{id:v("item"),type:"paragraph",data:{pretitle:"",title:"",text:"",image:{id:0,src:"",alt:""}},settings:{variant:"1",backgroundColor:""}}}function ee(a,t){const c=[],u=W();return c.push(p(m,{key:"layout-add-row",variant:"primary",onClick:()=>y(a,t,o=>{o.push(Y([])[0])})},n("Add row","wp-logical-theme"))),a.forEach((o,i)=>{const g=[];g.push(p(b,{key:`row-${o.id}-container`,label:n("Container","wp-logical-theme"),value:o.settings.container,options:[{value:"default",label:n("Default","wp-logical-theme")},{value:"wide",label:n("Wide","wp-logical-theme")},{value:"full",label:n("Full","wp-logical-theme")}],onChange:s=>y(a,t,l=>{l[i].settings.container=s})})),g.push(p(b,{key:`row-${o.id}-gap`,label:n("Gap","wp-logical-theme"),value:o.settings.gap,options:[{value:"none",label:n("None","wp-logical-theme")},{value:"sm",label:n("Small","wp-logical-theme")},{value:"md",label:n("Medium","wp-logical-theme")},{value:"lg",label:n("Large","wp-logical-theme")}],onChange:s=>y(a,t,l=>{l[i].settings.gap=s})})),g.push(p(b,{key:`row-${o.id}-align`,label:n("Vertical align","wp-logical-theme"),value:o.settings.alignY,options:[{value:"stretch",label:n("Stretch","wp-logical-theme")},{value:"start",label:n("Top","wp-logical-theme")},{value:"center",label:n("Center","wp-logical-theme")},{value:"end",label:n("Bottom","wp-logical-theme")}],onChange:s=>y(a,t,l=>{l[i].settings.alignY=s})})),g.push(p(b,{key:`row-${o.id}-bg`,label:n("Background","wp-logical-theme"),value:o.settings.backgroundColor,options:u,onChange:s=>y(a,t,l=>{l[i].settings.backgroundColor=s})})),g.push(p(m,{key:`row-${o.id}-add-column`,variant:"secondary",onClick:()=>y(a,t,s=>{s[i].columns.length>=6||s[i].columns.push({id:v("col"),type:"column",settings:{desktop:12,tablet:12,mobile:12,alignY:"stretch"},items:[]})})},n("Add column","wp-logical-theme"))),a.length>1&&g.push(p(m,{key:`row-${o.id}-remove`,variant:"secondary",isDestructive:!0,onClick:()=>y(a,t,s=>{s.splice(i,1)})},n("Remove row","wp-logical-theme"))),o.columns.forEach((s,l)=>{g.push(p("hr",{key:`row-${o.id}-col-${s.id}-separator`})),g.push(p("strong",{key:`row-${o.id}-col-${s.id}-title`},`${n("Column","wp-logical-theme")} ${l+1}`)),g.push(p(b,{key:`row-${o.id}-col-${s.id}-desktop`,label:n("Desktop span","wp-logical-theme"),value:String(s.settings.desktop),options:Array.from({length:12}).map((r,e)=>({value:String(e+1),label:String(e+1)})),onChange:r=>y(a,t,e=>{e[i].columns[l].settings.desktop=C(r)})})),g.push(p(b,{key:`row-${o.id}-col-${s.id}-tablet`,label:n("Tablet span","wp-logical-theme"),value:String(s.settings.tablet),options:Array.from({length:12}).map((r,e)=>({value:String(e+1),label:String(e+1)})),onChange:r=>y(a,t,e=>{e[i].columns[l].settings.tablet=C(r)})})),g.push(p(b,{key:`row-${o.id}-col-${s.id}-mobile`,label:n("Mobile span","wp-logical-theme"),value:String(s.settings.mobile),options:Array.from({length:12}).map((r,e)=>({value:String(e+1),label:String(e+1)})),onChange:r=>y(a,t,e=>{e[i].columns[l].settings.mobile=C(r)})})),g.push(p(m,{key:`row-${o.id}-col-${s.id}-add-paragraph`,variant:"secondary",onClick:()=>y(a,t,r=>{r[i].columns[l].items.push(L("paragraph"))})},n("Add paragraph item","wp-logical-theme"))),g.push(p(m,{key:`row-${o.id}-col-${s.id}-add-embed`,variant:"secondary",onClick:()=>y(a,t,r=>{r[i].columns[l].items.push(L("embed"))})},n("Add embed item","wp-logical-theme"))),o.columns.length>1&&g.push(p(m,{key:`row-${o.id}-col-${s.id}-remove`,variant:"secondary",isDestructive:!0,onClick:()=>y(a,t,r=>{r[i].columns.splice(l,1)})},n("Remove column","wp-logical-theme"))),s.items.forEach((r,e)=>{g.push(p("div",{key:`row-${o.id}-col-${s.id}-item-${r.id}-title`},`${n("Item","wp-logical-theme")} ${e+1} (${r.type})`)),g.push(p(b,{key:`row-${o.id}-col-${s.id}-item-${r.id}-type`,label:n("Item type","wp-logical-theme"),value:r.type,options:[{value:"paragraph",label:n("Paragraph","wp-logical-theme")},{value:"embed",label:n("Embed","wp-logical-theme")}],onChange:d=>y(a,t,f=>{f[i].columns[l].items[e]=L(d)})})),r.type==="paragraph"&&(g.push(p(O,{key:`row-${o.id}-col-${s.id}-item-${r.id}-title`,label:n("Title","wp-logical-theme"),value:h(r.data.title),onChange:d=>y(a,t,f=>{f[i].columns[l].items[e].data.title=d})})),g.push(p(K,{key:`row-${o.id}-col-${s.id}-item-${r.id}-text`,label:n("Text","wp-logical-theme"),value:h(r.data.text),onChange:d=>y(a,t,f=>{f[i].columns[l].items[e].data.text=d})}))),r.type==="embed"&&g.push(p(O,{key:`row-${o.id}-col-${s.id}-item-${r.id}-url`,label:n("Embed URL","wp-logical-theme"),value:h(r.data.url),onChange:d=>y(a,t,f=>{f[i].columns[l].items[e].data.url=d})})),g.push(p(m,{key:`row-${o.id}-col-${s.id}-item-${r.id}-remove`,variant:"secondary",isDestructive:!0,onClick:()=>y(a,t,d=>{d[i].columns[l].items.splice(e,1)})},n("Remove item","wp-logical-theme")))})}),c.push(p(D,{key:`row-${o.id}`,title:`${n("Row","wp-logical-theme")} ${i+1}`,initialOpen:!1},...g))}),c}z(E,{apiVersion:2,title:n(k==null?void 0:k.title,"wp-logical-theme"),icon:"layout",category:"widgets",attributes:{sectionId:{type:"string",default:""},sectionType:{type:"string",default:"paragraph"},data:{type:"object",default:{}},settings:{type:"object",default:{}}},supports:{html:!1},edit:function({attributes:t,setAttributes:c}){const u=U({className:"wp-block-logical-theme-paragraph"});B(()=>{t.sectionId||c({sectionId:v("sec")})},[t.sectionId,c]),B(()=>{t.sectionType!=="paragraph"&&c({sectionType:"paragraph"})},[t.sectionType,c]);const o=I(t,c);return p("div",u,p(A,null,p(D,{title:n("Content","wp-logical-theme"),initialOpen:!0},...o)),p("strong",null,n(k==null?void 0:k.title,"wp-logical-theme")),p(F,{key:`${E}:${t.sectionId||"new"}:${JSON.stringify(t.data||{})}:${JSON.stringify(t.settings||{})}`,block:E,attributes:t}))},save:function(){return null}});z(N,{apiVersion:2,title:n("Layout","wp-logical-theme"),icon:"screenoptions",category:"widgets",attributes:{layout:{type:"array",default:[]}},supports:{html:!1},edit:function({attributes:t,setAttributes:c}){const u=U({className:"wp-block-logical-theme-layout"});B(()=>{(!Array.isArray(t.layout)||t.layout.length===0)&&c({layout:Y([])})},[t.layout,c]);const o=Y(t.layout||[]),i=ee(o,c);return p("div",u,p(A,null,p(D,{title:n("Layout Builder","wp-logical-theme"),initialOpen:!0},...i)),p("strong",null,n("Layout","wp-logical-theme")),p(F,{key:`${N}:${JSON.stringify(o)}`,block:N,attributes:{layout:o}}))},save:function(){return null}});let V=null;X(()=>{const a=P("core/editor");if(!a||a.getCurrentPostType()!=="page")return;const c=P("core/block-editor");if(!c)return;const u=c.getBlocks(),o=u.filter(e=>e.name===N);let i;if(o.length>0)i={version:H,layout:_(o[0].attributes.layout||[])};else{const e=u.filter(d=>d.name===E);i={version:G,sections:e.map(d=>({id:d.attributes.sectionId||v("sec"),type:"paragraph",data:d.attributes.data||{},settings:d.attributes.settings||{}}))}}const g=a.getEditedPostAttribute("meta")||{},s=x(g[M]);if(s&&JSON.stringify(s)===JSON.stringify(i))return;const l=JSON.stringify(i);if(l===V)return;const r=Z("core/editor");r&&(r.editPost({meta:{...g,[M]:l}}),V=l)});
